<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Regression Calibration Demo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Regression Calibration demo_files/libs/clipboard/clipboard.min.js"></script>
<script src="Regression Calibration demo_files/libs/quarto-html/quarto.js"></script>
<script src="Regression Calibration demo_files/libs/quarto-html/popper.min.js"></script>
<script src="Regression Calibration demo_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Regression Calibration demo_files/libs/quarto-html/anchor.min.js"></script>
<link href="Regression Calibration demo_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Regression Calibration demo_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Regression Calibration demo_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Regression Calibration demo_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Regression Calibration demo_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#validation-study-available" id="toc-validation-study-available" class="nav-link active" data-scroll-target="#validation-study-available">1. Validation Study Available</a>
  <ul>
  <li><a href="#data-from-a-study-on-dietary-fat-intake-and-the-risk-of-breast-cancer" id="toc-data-from-a-study-on-dietary-fat-intake-and-the-risk-of-breast-cancer" class="nav-link" data-scroll-target="#data-from-a-study-on-dietary-fat-intake-and-the-risk-of-breast-cancer">1.1 Data from a Study on Dietary Fat Intake and the Risk of Breast Cancer</a>
  <ul>
  <li><a href="#variable-dictionary" id="toc-variable-dictionary" class="nav-link" data-scroll-target="#variable-dictionary">1.1.1 Variable Dictionary</a></li>
  </ul></li>
  <li><a href="#importing-data-with-external-validation-study" id="toc-importing-data-with-external-validation-study" class="nav-link" data-scroll-target="#importing-data-with-external-validation-study">1.2 Importing Data with External Validation Study</a></li>
  <li><a href="#naive-analysis" id="toc-naive-analysis" class="nav-link" data-scroll-target="#naive-analysis">1.3 Naive Analysis</a></li>
  <li><a href="#regression-calibration-imputation-method-rc-im" id="toc-regression-calibration-imputation-method-rc-im" class="nav-link" data-scroll-target="#regression-calibration-imputation-method-rc-im">1.4 Regression Calibration – Imputation Method (RC-IM)</a></li>
  <li><a href="#regression-calibration-deattenuation-factor-method-rc-df" id="toc-regression-calibration-deattenuation-factor-method-rc-df" class="nav-link" data-scroll-target="#regression-calibration-deattenuation-factor-method-rc-df">1.5 Regression Calibration – Deattenuation Factor Method (RC-DF)</a></li>
  <li><a href="#exercise" id="toc-exercise" class="nav-link" data-scroll-target="#exercise">1.6 Exercise</a></li>
  </ul></li>
  <li><a href="#reliability-study-available" id="toc-reliability-study-available" class="nav-link" data-scroll-target="#reliability-study-available">2. Reliability Study Available</a>
  <ul>
  <li><a href="#binary-outcome" id="toc-binary-outcome" class="nav-link" data-scroll-target="#binary-outcome">2.1 Binary Outcome</a>
  <ul>
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation">2.1.1 Installation</a></li>
  <li><a href="#external-reliability-data-available" id="toc-external-reliability-data-available" class="nav-link" data-scroll-target="#external-reliability-data-available">2.1.2 External reliability data available</a></li>
  <li><a href="#interval-reliability-study-available" id="toc-interval-reliability-study-available" class="nav-link" data-scroll-target="#interval-reliability-study-available">2.1.3 Interval reliability study available</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#other-packages-on-regression-calibration" id="toc-other-packages-on-regression-calibration" class="nav-link" data-scroll-target="#other-packages-on-regression-calibration">3. Other Packages on Regression Calibration</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Regression Calibration Demo</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>In this demo, we mainly focus on correcting for measurement error in covariates when the outcome is binary.</p>
<section id="validation-study-available" class="level2">
<h2 class="anchored" data-anchor-id="validation-study-available">1. Validation Study Available</h2>
<ul>
<li><p>Imputation Method: regCalibCRS</p></li>
<li><p>Deattenuation Method: regCalibRSW</p></li>
</ul>
<section id="data-from-a-study-on-dietary-fat-intake-and-the-risk-of-breast-cancer" class="level3">
<h3 class="anchored" data-anchor-id="data-from-a-study-on-dietary-fat-intake-and-the-risk-of-breast-cancer">1.1 Data from a Study on <a href="https://www.nejm.org/doi/full/10.1056/NEJM198701013160105">Dietary Fat Intake and the Risk of Breast Cancer</a></h3>
<ul>
<li><p>MS: 89,538 women returned a food frequency questionnaire (FFQ) in 1980 in the Nurses’ Health Study (NHS).Breast cancer incidence over the first 4 years of the follow-up was ascertained by self-report and validated through medical records review. Dietary intake (Z) was measured through a 61-item FFQ asking about the usual frequency of intake of the most common foods during the past year.</p></li>
<li><p>VS: 173 women from the MS. The VS participants recorded 4 one-week diet records (X) based on weighed food intake at 3-month intervals over a one-year period in 1981.</p></li>
</ul>
<section id="variable-dictionary" class="level5">
<h5 class="anchored" data-anchor-id="variable-dictionary">1.1.1 Variable Dictionary</h5>
<ul>
<li>Contained in both <strong>main and validation data</strong>:
<ul>
<li>fqcal: Daily total caloric intake in grams obtained from questionnaire.</li>
<li>fqcalinc: Daily total caloric intake in 10 g obtained from questionnaire</li>
<li>fqtfat: Daily total fat intake in kilo calories obtained from questionnaire</li>
<li>fqtfatinc: Daily total fat intake in 800 kcal obtained from questionnaire</li>
<li>fqalc: Daily alcohol intake in grams obtained from questionnaire</li>
<li>fqalcinc: Daily alcohol intake in 12 g obtained from questionnaire</li>
<li>age: Age in years</li>
<li>agec: Discretized age: &lt;40, [40, 45), [45, 55), [50,55),&gt;=50</li>
</ul></li>
<li>Contained in <strong>main data</strong>:
<ul>
<li>case: Binary outcome variable, if the breast cancer occurred during the four year follow-up</li>
</ul></li>
<li>Contained in <strong>validation data</strong>:
<ul>
<li>drcalinc:</li>
<li>drtfat:</li>
<li>drtfatinc:</li>
<li>dralc:</li>
<li>dralcinc:</li>
</ul></li>
</ul>
</section>
</section>
<section id="importing-data-with-external-validation-study" class="level3">
<h3 class="anchored" data-anchor-id="importing-data-with-external-validation-study">1.2 Importing Data with External Validation Study</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in the main study data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>main_data<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"validation_main_part1.dat"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># read in the validation study data</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>valid_data<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"validation_valid_part1.dat"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># show the first 5 rows of the data</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(main_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      id fqcal fqcalinc fqtfat fqtfatinc  fqalc  fqalcinc      age  agec case
1 100008  1661  2.07625     88       8.8  8.413 0.7010833 48.75000 45~50    0
2 100013  1573  1.96625     65       6.5  0.000 0.0000000 37.83333   &lt;40    0
3 100015  1071  1.33875     44       4.4  7.549 0.6290833 45.66667 45~50    0
4 100017  1000  1.25000     52       5.2 29.114 2.4261667 48.08333 45~50    0
5 100018  2013  2.51625     79       7.9 11.137 0.9280833 54.91667 50~55    0
6 100022  3073  3.84125    133      13.3  0.000 0.0000000 52.50000 50~55    0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(valid_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      id  fqcal fqcalinc fqtfat fqtfatinc fqalc  fqalcinc drcal drcalinc drtfat
1 100396 1242.2 1.552750   53.8      5.38  1.68 0.1400000  1807  2.25875  81.15
2 100566  907.0 1.133750   36.6      3.66  0.00 0.0000000  1418  1.77250  53.28
3 107633  786.0 0.982500   47.2      4.72 15.10 1.2583333  1889  2.36125  83.48
4 107737 1392.5 1.740625   55.3      5.53  7.49 0.6241667  1426  1.78250  49.65
5 107744 1259.8 1.574750   71.0      7.10 12.84 1.0700000  1253  1.56625  55.18
6 107813  987.1 1.233875   41.1      4.11  0.00 0.0000000  1699  2.12375  73.83
  drtfatinc dralc   dralcinc age  agec
1     8.115  8.26 0.68833333  39   &lt;40
2     5.328  0.83 0.06916667  49 45~50
3     8.348 20.13 1.67750000  43 40~45
4     4.965 11.16 0.93000000  51 50~55
5     5.518  7.18 0.59833333  53 50~55
6     7.383  1.76 0.14666667  54 50~55</code></pre>
</div>
</div>
<p><strong>Outcome model</strong>: <span class="math display">\[
\begin{aligned}
&amp;logit(\text{Probability of breast cancer occured})\\
&amp;=\text{fat }(10g/day)\;+\;\text{calories }(800kcal/day)\;+\;\text{alcohol }(12g/day)\\
&amp;\quad +\; \mathbf{1}\!\left(\text{age}\in[40,45)\right)
+\mathbf{1}\!\left(\text{age}\in[45,50)\right)
+\mathbf{1}\!\left(\text{age}\in[50,55)\right)
+\mathbf{1}\!\left(\text{age}\ge 50\right).
\end{aligned}
\]</span></p>
<p>(age <span class="math inline">\(&lt;40\)</span> is the reference category for age.)</p>
<p><strong>Measurement error model</strong>: <span class="math display">\[
\begin{aligned}
\mathrm{DR\_Alcohol}(12g/day)
&amp;= \mathrm{FFQ\_Alcohol}(12g/day)
+ \mathrm{FFQ\_Total\_Fat}(10g/day)
+ \mathrm{FFQ\_Calories}(800kcal/day) \\
&amp;\quad + \mathbf{1}\!\left(\mathrm{Age}\in[40,45)\right)
+ \mathbf{1}\!\left(\mathrm{Age}\in[45,50)\right)
+ \mathbf{1}\!\left(\mathrm{Age}\in[50,55)\right)
+ \mathbf{1}\!\left(\mathrm{Age}\ge 50\right), \\[6pt]
\mathrm{DR\_Total\_Fat}(10g/day)
&amp;= \mathrm{FFQ\_Total\_Fat}(10g/day)
+ \mathrm{FFQ\_Alcohol}(12g/day)
+ \mathrm{FFQ\_Calories}(800kcal/day) \\
&amp;\quad + \mathbf{1}\!\left(\mathrm{Age}\in[40,45)\right)
+ \mathbf{1}\!\left(\mathrm{Age}\in[45,50)\right)
+ \mathbf{1}\!\left(\mathrm{Age}\in[50,55)\right)
+ \mathbf{1}\!\left(\mathrm{Age}\ge 50\right), \\[6pt]
\mathrm{DR\_Calories}(800kcal/day)
&amp;= \mathrm{FFQ\_Calories}(800kcal/day)
+ \mathrm{FFQ\_Alcohol}(12g/day)
+ \mathrm{FFQ\_Total\_Fat}(10g/day) \\
&amp;\quad + \mathbf{1}\!\left(\mathrm{Age}\in[40,45)\right)
+ \mathbf{1}\!\left(\mathrm{Age}\in[45,50)\right)
+ \mathbf{1}\!\left(\mathrm{Age}\in[50,55)\right)
+ \mathbf{1}\!\left(\mathrm{Age}\ge 50\right).
\end{aligned}
\]</span></p>
</section>
<section id="naive-analysis" class="level3">
<h3 class="anchored" data-anchor-id="naive-analysis">1.3 Naive Analysis</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Logistic regression in the MS</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fqtfatinc = fqtfat/10, fqcalinc = fqcal/800, fqalcinc=fqalc/12, for having the pre-specified</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># increments in the interpretations of their coefficients in the logistic regression model</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>uncorrected <span class="ot">&lt;-</span> <span class="fu">glm</span>(case <span class="sc">~</span> fqtfatinc <span class="sc">+</span> fqcalinc <span class="sc">+</span> fqalcinc <span class="sc">+</span> agec, <span class="at">data=</span>main_data, <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>uncorrected_results<span class="ot">&lt;-</span><span class="fu">exp</span>(<span class="fu">cbind</span>(<span class="at">OR =</span> <span class="fu">coef</span>(uncorrected), <span class="fu">confint</span>(uncorrected)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>uncorrected_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    OR       2.5 %     97.5 %
(Intercept) 0.00380417 0.002696806 0.00531978
fqtfatinc   0.97883434 0.924601002 1.03613092
fqcalinc    1.00207749 0.770922385 1.29395543
fqalcinc    1.14859818 1.064814610 1.23386158
agec&gt;=50    2.66079494 2.004133696 3.56370240
agec40~45   1.41923883 1.041903968 1.94118652
agec45~50   2.28648649 1.731062686 3.04929876
agec50~55   2.25490565 1.702950573 3.01337360</code></pre>
</div>
</div>
</section>
<section id="regression-calibration-imputation-method-rc-im" class="level3">
<h3 class="anchored" data-anchor-id="regression-calibration-imputation-method-rc-im">1.4 Regression Calibration – Imputation Method (RC-IM)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># source the function for RC-IM</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"regCalibCRS.R"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>echo<span class="ot">=</span><span class="cn">FALSE</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># call regCalibCRS</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>rcim <span class="ot">&lt;-</span> <span class="fu">regCalibCRS</span>(<span class="at">ms =</span> main_data, <span class="co">#MS</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="at">vs =</span> valid_data, <span class="co">#VS</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="at">sur =</span> <span class="fu">c</span>(<span class="st">"fqtfatinc"</span>,<span class="st">"fqcalinc"</span>,<span class="st">"fqalcinc"</span>), <span class="co">#Mismeasured exposures and covaraites</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="at">exp =</span> <span class="fu">c</span>(<span class="st">"drtfatinc"</span>,<span class="st">"drcalinc"</span>,<span class="st">"dralcinc"</span>),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Correctly measured exposure and covaraites with one-to-one correspondence to `sur`</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="at">covCalib =</span> <span class="fu">c</span>(<span class="st">"agec"</span>),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Error-free covariates to adjust for in calibration model including non-linear terms.</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="at">covOutcome =</span> <span class="fu">c</span>(<span class="st">"agec"</span>),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Error-free covariates to adjust for in outcome model including non-linear terms.</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="at">outcome =</span> <span class="st">"case"</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="at">method =</span> <span class="st">"glm"</span>, <span class="co">#Methods for outcome modeling</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="at">family =</span> binomial, <span class="co">#Family parameter being passed to glm</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="at">link =</span> <span class="st">"logit"</span>, <span class="co">#Link function being passed to glm</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="at">external =</span> <span class="cn">TRUE</span> <span class="co">#Indicates whether `vs` is an external validation set.</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Corrected regression coefficients (exponentiated)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>corrected_RC_IM<span class="ot">&lt;-</span><span class="fu">exp</span>(<span class="fu">cbind</span>(<span class="at">OR =</span> rcim<span class="sc">$</span>correctedCoefTable[,<span class="dv">1</span>],</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="st">'2.5 %'</span> <span class="ot">=</span> rcim<span class="sc">$</span>correctedCoefTable[,<span class="dv">5</span>],</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="st">'97.5 %'</span> <span class="ot">=</span> rcim<span class="sc">$</span>correctedCoefTable[,<span class="dv">6</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>corrected_RC_IM</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 OR     2.5 %   97.5 %
drtfatinc 0.9335793 0.7938254 1.097937
drcalinc  1.0069521 0.4353128 2.329251
dralcinc  1.2436176 1.0547162 1.466352
agec&gt;=50  2.5370281 1.9089889 3.371686
agec40~45 1.4257748 1.1067126 1.836822
agec45~50 2.1405215 1.6312957 2.808707
agec50~55 2.1353751 1.6308090 2.796052</code></pre>
</div>
</div>
</section>
<section id="regression-calibration-deattenuation-factor-method-rc-df" class="level3">
<h3 class="anchored" data-anchor-id="regression-calibration-deattenuation-factor-method-rc-df">1.5 Regression Calibration – Deattenuation Factor Method (RC-DF)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"regCalibRSW.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>rcdf <span class="ot">&lt;-</span> <span class="fu">regCalibRSW</span>(<span class="at">supplyEstimates =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="at">ms =</span> main_data,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="at">vs =</span> valid_data,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="at">sur =</span> <span class="fu">c</span>(<span class="st">"fqtfatinc"</span>,<span class="st">"fqcalinc"</span>,<span class="st">"fqalcinc"</span>), <span class="co"># mismeasured exposures and covaraites</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="at">exp =</span> <span class="fu">c</span>(<span class="st">"drtfatinc"</span>,<span class="st">"drcalinc"</span>,<span class="st">"dralcinc"</span>),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="at">covCalib =</span> <span class="fu">c</span>(<span class="st">"agec"</span>),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="at">covOutcome =</span> <span class="cn">NULL</span>, <span class="co"># Correctly measured risk factors for outcome in the MS</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Should not include any variable from `covCalib`</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="at">outcome =</span> <span class="st">"case"</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="at">method =</span> <span class="st">"glm"</span>, <span class="co"># methods for outcome modeling</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="at">family =</span> binomial, <span class="co"># family parameter being passed to glm</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="at">link =</span> <span class="st">"logit"</span>, <span class="co"># link function being passed to glm</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="at">external =</span> <span class="cn">TRUE</span>, <span class="co"># Indicates whether `vs` is an external validation set.</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="at">pointEstimates =</span> <span class="cn">NA</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="at">vcovEstimates =</span> <span class="cn">NA</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Corrected regression coefficients (exponentiated)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>corrected_RC_DF<span class="ot">&lt;-</span><span class="fu">exp</span>(<span class="fu">cbind</span>(<span class="at">OR =</span> rcdf<span class="sc">$</span>correctedCoefTable[,<span class="dv">1</span>],</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="st">'2.5 %'</span> <span class="ot">=</span> rcdf<span class="sc">$</span>correctedCoefTable[,<span class="dv">5</span>],</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="st">'97.5 %'</span> <span class="ot">=</span> rcdf<span class="sc">$</span>correctedCoefTable[,<span class="dv">6</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>corrected_RC_DF</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 OR     2.5 %   97.5 %
drtfatinc 0.9335793 0.7938682 1.097878
drcalinc  1.0069521 0.4517235 2.244631
dralcinc  1.2436176 1.0766925 1.436422
agec&gt;=50  2.5370281 1.8622682 3.456275
agec40~45 1.4257748 1.0381491 1.958133
agec45~50 2.1405215 1.5678133 2.922435
agec50~55 2.1353751 1.5683911 2.907328</code></pre>
</div>
</div>
<p>Compare results from naive, imputed, and deattenuation methods:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(uncorrected_results[<span class="sc">-</span><span class="dv">1</span>,], corrected_RC_IM, corrected_RC_DF)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 OR     2.5 %   97.5 %        OR     2.5 %   97.5 %        OR
fqtfatinc 0.9788343 0.9246010 1.036131 0.9335793 0.7938254 1.097937 0.9335793
fqcalinc  1.0020775 0.7709224 1.293955 1.0069521 0.4353128 2.329251 1.0069521
fqalcinc  1.1485982 1.0648146 1.233862 1.2436176 1.0547162 1.466352 1.2436176
agec&gt;=50  2.6607949 2.0041337 3.563702 2.5370281 1.9089889 3.371686 2.5370281
agec40~45 1.4192388 1.0419040 1.941187 1.4257748 1.1067126 1.836822 1.4257748
agec45~50 2.2864865 1.7310627 3.049299 2.1405215 1.6312957 2.808707 2.1405215
agec50~55 2.2549056 1.7029506 3.013374 2.1353751 1.6308090 2.796052 2.1353751
              2.5 %   97.5 %
fqtfatinc 0.7938682 1.097878
fqcalinc  0.4517235 2.244631
fqalcinc  1.0766925 1.436422
agec&gt;=50  1.8622682 3.456275
agec40~45 1.0381491 1.958133
agec45~50 1.5678133 2.922435
agec50~55 1.5683911 2.907328</code></pre>
</div>
</div>
</section>
<section id="exercise" class="level3">
<h3 class="anchored" data-anchor-id="exercise">1.6 Exercise</h3>
<ol type="1">
<li>If we correct measurement error only for total fat intake (fqtfatinc) and leave total calories and alcohol (fqcalinc, fqalcinc) uncorrected in the outcome model, how should we modify the code? How do the resulting estimates compare with the model in which all three exposures are corrected?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># put your code here </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>If we correct measurement error only for total fat and total calories (fqtfatinc, fqcalinc) and leave alcohol intake (fqalcinc) uncorrected in the outcome model, how should we modify the code? How do the results compare with the model in which all three exposures are corrected?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># put your code here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>What if we have interval validation data rather than external validation data? Which argument should we change?</li>
</ol>
<!-- ### 1.2 Linear Model with Continuous Outcome -->
<!-- Need fill in the continuous outcome demo. -->
</section>
</section>
<section id="reliability-study-available" class="level2">
<h2 class="anchored" data-anchor-id="reliability-study-available">2. Reliability Study Available</h2>
<p>You will learn how to deal with measurement error in covariates when internal and external reliability study is available using R package <strong>RegCalReliab</strong>. More details of the usage of the package are <a href="https://lbw080526.github.io/RegCalReliab/articles/regcal_example.html">here</a>.</p>
<section id="binary-outcome" class="level3">
<h3 class="anchored" data-anchor-id="binary-outcome">2.1 Binary Outcome</h3>
<section id="installation" class="level4">
<h4 class="anchored" data-anchor-id="installation">2.1.1 Installation</h4>
<p>You can install the development version of RegCalReliab from GitHub:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># library(devtools)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install_github("Lbw080526/RegCalReliab")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can also get the official release version from CRAN:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("RegCalReliab")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="external-reliability-data-available" class="level4">
<h4 class="anchored" data-anchor-id="external-reliability-data-available">2.1.2 External reliability data available</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RegCalReliab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Explain the data generation details:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>reliability_main_data_external <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"reliability_main_data_external.csv"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>reliability_rep_data_external <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"reliability_rep_data_external.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">RC_ExReliab</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> Y <span class="sc">~</span> <span class="fu">z1</span>(z1_1, z1_2, z1_3, z1_4) <span class="sc">+</span> <span class="fu">z2</span>(z2_1, z2_2, z2_3, z2_4) <span class="sc">+</span> W1 <span class="sc">+</span> W2,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">main_data =</span> reliability_main_data_external,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">rep_data =</span> reliability_rep_data_external,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">link =</span> <span class="st">"logistic"</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$uncorrected
              Estimate Std. Error    z value      Pr(&gt;|z|)         OR
(Intercept) -2.3276590 0.09586512 -24.280562 3.145792e-130 0.09752378
z1           0.1548408 0.07620390   2.031928  4.216097e-02 1.16747212
z2           0.1585020 0.07586454   2.089276  3.668289e-02 1.17175422
W1           0.4657777 0.09249499   5.035708  4.760869e-07 1.59325279
W2          -0.2142428 0.17619942  -1.215911  2.240188e-01 0.80715236
                CI.low   CI.high
(Intercept) 0.08081807 0.1176827
z1          1.00549623 1.3555408
z2          1.00985571 1.3596080
W1          1.32908074 1.9099325
W2          0.57144120 1.1400910

$corrected
              Estimate Std. Error    z value     Pr(&gt;|z|)         OR     CI.low
(Intercept) -2.3276590 0.09716735 -23.955157 2.000000e+00 0.09752378 0.08061206
z1           0.2066148 0.11121158   1.857853 6.318989e-02 1.22950884 0.98870435
z2           0.2116893 0.11093710   1.908192 5.636639e-02 1.23576387 0.99426907
W1           0.4640322 0.08629795   5.377095 7.569744e-08 1.59047421 1.34297626
W2          -0.2129560 0.17644342  -1.206937 1.772543e+00 0.80819169 0.57190344
              CI.high
(Intercept) 0.1179834
z1          1.5289626
z2          1.5359146
W1          1.8835837
W2          1.1421050

attr(,"class")
[1] "RC_EX_logistic_result" "list"                 </code></pre>
</div>
</div>
</section>
<section id="interval-reliability-study-available" class="level4">
<h4 class="anchored" data-anchor-id="interval-reliability-study-available">2.1.3 Interval reliability study available</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>reliability_main_data_internal <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"reliability_main_data_internal.csv"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ---- Regression calibration ----</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">RC_InReliab</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula   =</span> Y <span class="sc">~</span> <span class="fu">myz1</span>(z1_1, z1_2, z1_3, z1_4) <span class="sc">+</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">myz2</span>(z2_1, z2_2, z2_3, z2_4) <span class="sc">+</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>                  W1 <span class="sc">+</span> W2,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">main_data =</span> reliability_main_data_internal,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">link      =</span> <span class="st">"logistic"</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$uncorrected
              Estimate Std. Error    z value      Pr(&gt;|z|)         OR
(Intercept) -2.4375854 0.07401290 -32.934603 7.028531e-238 0.08737157
myz1         0.3090961 0.05855210   5.278993  1.298957e-07 1.36219329
myz2         0.3639732 0.06303186   5.774433  7.721275e-09 1.43903570
W1           0.3441134 0.07003784   4.913250  8.957871e-07 1.41073866
W2           0.3277845 0.12618297   2.597692  9.385261e-03 1.38788985
                CI.low   CI.high
(Intercept) 0.07557342 0.1010116
myz1        1.21450187 1.5278450
myz2        1.27179691 1.6282661
W1          1.22978490 1.6183184
W2          1.08379187 1.7773138

$corrected
              Estimate Std. Error    z value     Pr(&gt;|z|)         OR     CI.low
(Intercept) -2.4398323 0.07381375 -33.053899 2.000000e+00 0.08717547 0.07543324
myz1         0.3933826 0.07971607   4.934796 8.023438e-07 1.48198528 1.26761742
myz2         0.4552969 0.08709030   5.227872 1.714726e-07 1.57664144 1.32923013
W1           0.2837146 0.07417669   3.824849 1.308525e-04 1.32805389 1.14835250
W2           0.2891216 0.12992388   2.225315 2.606009e-02 1.33525407 1.03507178
              CI.high
(Intercept) 0.1007455
myz1        1.7326051
myz2        1.8701037
W1          1.5358761
W2          1.7224926

attr(,"class")
[1] "RC_IN_logistic_result" "list"                 </code></pre>
</div>
</div>
<!-- ### 2.2 Continuous Outcome -->
</section>
</section>
</section>
<section id="other-packages-on-regression-calibration" class="level2">
<h2 class="anchored" data-anchor-id="other-packages-on-regression-calibration">3. Other Packages on Regression Calibration</h2>
<p>The R package <strong>mecor</strong> implements regression calibration for linear model with continuous outcomes. More details of the usage of the package can be find <a href="https://cran.r-project.org/web/packages/mecor/refman/mecor.html">here</a>.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>